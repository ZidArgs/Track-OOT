async function loadAll(){var e=await FileLoader.loadAllJSON(["database/items.json","database/grids.json","database/chests.json","database/dungeons.json","database/skulltulas.json","database/songs.json","database/hints.json","database/logic.json","database/rom_options.json","database/shops.json","database/shop_items.json","database/lang_en.json"]),t={};return t.items=e.shift(),t.grids=e.shift(),t.chests=e.shift(),t.dungeons=e.shift(),t.skulltulas=e.shift(),t.songs=e.shift(),t.hints=e.shift(),t.logic=e.shift(),t.logic_patched=Storage.get("settings","logic",{}),t.rom_options=e.shift(),t.shops=e.shift(),t.shop_items=e.shift(),t.lang=e.shift(),t}function checkLogicObject(e){if(!e||null==e)return!0;switch(e.type){case"and":if(!e.el.length)return!0;for(let a=0;a<e.el.length;++a){if((t=e.el[a])&&null!=t&&!checkLogicObject(t))return!1}return!0;case"or":if(!e.el.length)return!0;for(let a=0;a<e.el.length;++a){var t=e.el[a];if(t&&null!=t&&checkLogicObject(t))return!0}return!1;case"not":return!checkLogicObject(e.el);case"equal":return checkLogicObject(e.el)==e.value;case"value":case"min":return checkLogicObject(e.el)>=e.value;case"mixin":return checkLogic("mixins",e.el);case"skip":a=SaveState.read("skips",e.el,data.rom_options.skips[e.el].default);return e.hasOwnProperty("value")?a==e.value:a;case"setting":case"option":var a=SaveState.read("options",e.el,data.rom_options.options[e.el].default);return e.hasOwnProperty("value")?a==e.value:a;case"item":return SaveState.read("items",e.el,0);default:return!1}}function checkLogicArray(e){if(0==e.length)return!0;e:for(var t=0;t<e.length;++t){for(var a=e[t],n=0;n<a.length;++n){var i=a[n],s=!0;i.startsWith("!")&&(s=!1,i=i.slice(1));var[o,l]=i.split(":");o=o.split(".");var r=SaveState.read(o[0],o[1],0);if(l){if(r<l==s)continue e}else if(!r==s)continue e}return!0}return!1}function getLogic(e,t){return Storage.get("settings","use_custom_logic",!1)&&data.logic_patched.hasOwnProperty(e)&&data.logic_patched[e].hasOwnProperty(t)?data.logic_patched[e][t]:data.logic.hasOwnProperty(e)||data.logic[e].hasOwnProperty(t)?data.logic[e][t]:void 0}function checkLogic(e,t){var a=getLogic(e,t);return void 0!==a&&(Array.isArray(a)?checkLogicArray(a):checkLogicObject(a))}function checkAvailable(e,t){return checkLogic(e,t)?"available":"unavailable"}function checkOpened(e,t){var a=data.dungeons[t][e];for(let t in a)if(!SaveState.read(e,t,0))return!1;return!0}function checkBeatList(e){var t=data.logic.dungeons[e];return Array.isArray(t)&&0==t.length||null==t?checkList("chests",e):checkOpened("chests",e)?"opened":checkLogic("dungeons",e)?"available":"unavailable"}function checkList(e,t){var a;a="overworld"==t?data[e]:data.dungeons[t].hasmq&&SaveState.read("mq",t,!1)?data.dungeons[t][e+"_mq"]:data.dungeons[t][e];var n=0,i=0;for(let t in a)a[t].mode&&"scrubsanity"==a[t].mode&&!SaveState.read("options","scrubsanity",!1)||SaveState.read(e,t,0)||(i++,checkLogic(e,t)&&n++);return 0==i?"opened":n==i?"available":0==n?"unavailable":"possible"}function Item(e,t){function a(){n.always_active||0!=i?s.classList.remove("item-inactive"):s.classList.add("item-inactive"),data.items[s.id].counting&&(Array.isArray(data.items[e].counting)?s.innerHTML=data.items[e].counting[i]:s.innerHTML=0==i?"":i),function(){if(data.items[e].hasOwnProperty("images")){let t=data.items[e].images;Array.isArray(t)?s.style.backgroundImage="url('images/"+t[i]+"')":"string"==typeof t&&(s.style.backgroundImage="url('images/"+t+"')")}}();var t=n.max;n.hasOwnProperty("related_dungeon")&&SaveState.read("mq",n.related_dungeon,!1)&&(t=n.maxmq||t),n.hasOwnProperty("mark")&&i>=n.mark||i>=t?s.classList.add("mark"):s.classList.remove("mark")}var n=data.items[e],i=SaveState.read("items",e,0),s=document.createElement("DIV");s.id=e,s.classList.add("item"),a(),s.onclick=function(t){var s=n.max;return n.hasOwnProperty("related_dungeon")&&SaveState.read("mq",n.related_dungeon,!1)&&(s=n.maxmq||s),i<s&&(SaveState.write("items",e,++i),a(),updateItems(),updateMap()),t.preventDefault(),!1},s.oncontextmenu=function(t){return i>0&&(SaveState.write("items",e,--i),a(),updateItems(),updateMap()),t.preventDefault(),!1},t.appendChild(s),this.update=function(){i=SaveState.read("items",e,0),a()}}function ToggleMQ(e,t){var a=SaveState.read("mq",e,!1),n=document.createElement("DIV");n.id=name,n.classList.add("switch"),n.innerHTML=a?"MQ":"V",n.onclick=function(t){return a=!a,SaveState.write("mq",e,a),n.innerHTML=a?"MQ":"V",reloadDungeonList(),t.preventDefault(),!1},t.appendChild(n),this.update=function(){a=SaveState.read("mq",e,!1),n.innerHTML=a?"MQ":"V"}}function ToggleReward(e,t){var a=[!1,"stone_forest","stone_fire","stone_water","medallion_forest","medallion_fire","medallion_water","medallion_spirit","medallion_shadow","medallion_light"],n=0,i=document.createElement("DIV");i.id=name,i.classList.add("switch"),i.onclick=function(t){return++n>=a.length&&(n=1),SaveState.write("rewards",e,n),i.innerHTML="",i.style.backgroundImage="url('images/"+data.items[a[n]].images+"')",t.preventDefault(),!1},i.oncontextmenu=function(t){return n=0,SaveState.write("rewards",e,n),i.innerHTML="?",i.style.backgroundImage="",t.preventDefault(),!1},t.appendChild(i),this.update=function(){n=SaveState.read("rewards",e,0),i.innerHTML=n?"":"?",i.style.backgroundImage=n?"url('images/"+data.items[a[n]].images+"')":""},this.update()}function DungeonStatus(e,t){function a(e){var t=document.createElement("DIV");return t.classList.add("text"),t.innerHTML=e,t}var n,i,s,o,l,r,d,c=document.createElement("DIV");c.classList.add("item-row"),t.appendChild(c),(n=a(e.title)).style.color=e.color,c.appendChild(n),e.keys?i=new Item(e.keys,c):c.appendChild(a("")),e.bosskey?s=new Item(e.bosskey,c):c.appendChild(a("")),e.map?o=new Item(e.map,c):c.appendChild(a("")),e.compass?l=new Item(e.compass,c):c.appendChild(a("")),e.boss_reward?r=new ToggleReward(e.ref,c):c.appendChild(a("")),e.hasmq?d=new ToggleMQ(e.ref,c):c.appendChild(a("")),this.update=function(){i&&i.update(),s&&s.update(),o&&o.update(),l&&l.update(),r&&r.update(),d&&d.update()}}function createItemTracker(){createGrid(document.getElementById("item-container"),data.grids.items),createGrid(document.getElementById("key-container"),data.grids.keys);for(var e=data.grids.dungeons,t=0;t<e.length;++t)itemGridEls.push(new DungeonStatus(e[t],document.getElementById("dungeon-status-container")))}function createGrid(e,t){for(let i=0;i<t.length;++i){var a=document.createElement("DIV");a.classList.add("item-row");var n=t[i];for(let e=0;e<n.length;++e){let t=n[e];t.startsWith("icon:")?createItemIcon(a,(t=t.split("#"))[0].slice(5),t[1]):t.startsWith("text:")?createItemText(a,(t=t.split("#"))[0].slice(5),t[1]):createItemButton(a,t)}e.appendChild(a)}}function createItemButton(e,t){itemGridEls.push(new Item(t,e))}function createItemIcon(e,t,a){var n=document.createElement("DIV");n.classList.add("icon"),a&&(n.id=a),n.style.backgroundImage="url('images/"+t+"')",e.appendChild(n)}function createItemText(e,t,a){var n=document.createElement("DIV");n.classList.add("text"),a&&(n.id=a),n.innerHTML=t,e.appendChild(n)}function toggleItem(e){var t=e.currentTarget,a=SaveState.read("items",t.id,0),n=data.items[t.id],i=n.max;return n.hasOwnProperty("related_dungeon")&&SaveState.read("mq",n.related_dungeon,!1)&&(i=n.maxmq||i),a<i&&(SaveState.write("items",t.id,++a),setVisual(t,a),updateMap()),e.preventDefault(),!1}function untoggleItem(e){var t=e.currentTarget,a=SaveState.read("items",t.id,0);data.items[t.id];return a>0&&(SaveState.write("items",t.id,--a),setVisual(t,a),updateMap()),e.preventDefault(),!1}function setVisual(e,t){var a=data.items[e.id];a.always_active||0!=t?e.classList.remove("item-inactive"):e.classList.add("item-inactive"),data.items[e.id].counting&&(Array.isArray(data.items[e.id].counting)?e.innerHTML=data.items[e.id].counting[t]:e.innerHTML=0==t?"":t),setImage(e,e.id,t);var n=a.max;a.hasOwnProperty("related_dungeon")&&SaveState.read("mq",a.related_dungeon,!1)&&(n=a.maxmq||n),a.hasOwnProperty("mark")&&t>=a.mark||t>=n?e.classList.add("mark"):e.classList.remove("mark")}function setImage(e,t,a){if(data.items[t].hasOwnProperty("images")){let n=data.items[t].images;Array.isArray(n)?e.style.backgroundImage="url('images/"+n[a]+"')":"string"==typeof n&&(e.style.backgroundImage="url('images/"+n+"')")}else e.style.backgroundImage="url('images/unknown.png')"}function updateItems(){for(var e=0;e<itemGridEls.length;++e)itemGridEls[e].update()}function Map(e,t,a,n){var i=document.createElement("div");i.id="map",i.style.backgroundImage='url("'+t+'")',i.style.width="calc("+a+"px * var(--map-scale))",i.style.height="calc("+n+"px * var(--map-scale))",e.appendChild(i)}function Tooltip(e,t,a){a instanceof HTMLElement||(a=document.body);var n=document.createElement("div");n.className="tooltip",n.innerHTML=t,e.addEventListener("mouseover",function(e){a.appendChild(n);var t=a.clientWidth,i=a.clientHeight,s=e.pageX,o=e.pageY,l=n.clientWidth+40,r=n.clientHeight+20;o+20+r>=i?o-=r:o+=20,s+20+l>=t?s=t-l:s+=20,n.style.left=s+"px",n.style.top=o+"px"}),e.addEventListener("mouseout",function(e){a.removeChild(n)})}function SongBuilder(e){function t(t){e.push(t.target.getAttribute("data-note")),a()}function a(){i.innerHTML="";for(let n=0;n<e.length;++n){var t=e[n],a=document.createElement("div");a.className="note note_"+t,i.appendChild(a)}}var n=document.createElement("div");n.className="song";var i=document.createElement("div");i.className="stave",n.appendChild(i);var s=document.createElement("div");s.className="button-container";var o=document.createElement("div");o.className="btn btn_A",o.setAttribute("data-note","A"),o.onclick=t,s.appendChild(o);var l=document.createElement("div");l.className="btn btn_D",l.setAttribute("data-note","D"),l.onclick=t,s.appendChild(l);var r=document.createElement("div");r.className="btn btn_R",r.setAttribute("data-note","R"),r.onclick=t,s.appendChild(r);var d=document.createElement("div");d.className="btn btn_L",d.setAttribute("data-note","L"),d.onclick=t,s.appendChild(d);var c=document.createElement("div");c.className="btn btn_U",c.setAttribute("data-note","U"),c.onclick=t,s.appendChild(c);var u=document.createElement("div");return u.className="btn btn_X",u.onclick=function(){e.pop(),a()},s.appendChild(u),n.appendChild(s),a(),n.getSong=function(){return e},n}function ShopItemChoice(){function e(e){n&&s.querySelector("#shop-item-category-"+n).classList.remove("active");let t=e.currentTarget;n=t.getAttribute("data-target"),s.querySelector("#shop-item-category-"+n).classList.add("active"),e.stopPropagation()}function t(e){a&&s.querySelector("#shop-item-"+a).classList.remove("active");let t=e.currentTarget;a=t.getAttribute("data-value"),t.classList.add("active"),e.stopPropagation()}let a="",n="",i=data.shop_items,s=document.createElement("div");s.className="shop-items";let o=document.createElement("div");o.className="shop-items-buttonlist",s.appendChild(o);let l=document.createElement("div");l.className="shop-items-container",s.appendChild(l);let r={};for(let e in i){let a=i[e],n=r[a.category];n||((n=document.createElement("div")).className="shop-item-category",n.id="shop-item-category-"+a.category,r[a.category]=n);let s=document.createElement("div");s.setAttribute("data-value",e),s.id="shop-item-"+e,s.onclick=t,s.className="shop-item";let o=document.createElement("div");o.className="shop-item-image",o.style.backgroundImage="url('images/"+a.image+"')",s.appendChild(o);let l=document.createElement("div");l.innerHTML=translate(e)+(a.refill?"":" "+translate("special_deal")),l.className="shop-item-title",s.appendChild(l),n.appendChild(s)}for(let t in r){let a=r[t];n||(n=t,a.classList.add("active")),l.appendChild(a);let i=document.createElement("div");i.innerHTML=translate(t),i.className="shop-item-categorybutton",i.setAttribute("data-target",t),i.onclick=e,o.appendChild(i)}return s.getValue=function(){return a},s}function ShopBuilder(e){function t(){let t=event.currentTarget.getAttribute("data-slot"),n=new ShopItemChoice,i=new Dialog(function(i){if(i){let i=n.getValue(),s=data.shop_items[i];if(s.price)e[t]={item:i,price:s.price},a();else{let n=document.createElement("input");n.setAttribute("type","number"),n.setAttribute("min-value",1),n.setAttribute("max-value",999),n.value=e[t].price;let s=new Dialog(function(s){s&&(e[t]={item:i,price:n.value},a())});s.setTitle("Slot "+(t+1)+" Price"),s.setSubmitText("SUBMIT"),s.setAbortText("CANCEL"),s.addElement(n)}}});i.setTitle("Slot "+(t+1)+" Item"),i.setSubmitText("SUBMIT"),i.setAbortText("CANCEL"),i.addElement(n)}function a(){n.innerHTML="";for(let a=0;a<e.length;++a){let i=e[a],s=data.shop_items[i.item],o=document.createElement("div");o.setAttribute("data-slot",a),o.onclick=t,o.className="shop-item";let l=document.createElement("div");l.className="shop-item-image",l.style.backgroundImage="url('images/"+s.image+"')",o.appendChild(l);let r=document.createElement("div");r.innerHTML=translate(i.item)+(s.refill?"":" "+translate("special_deal")),r.className="shop-item-title",o.appendChild(r);let d=document.createElement("div");d.innerHTML=i.price,d.className="shop-item-price",o.appendChild(d),n.appendChild(o)}}var n=document.createElement("div");return n.className="shop",a(),n.getShop=function(){return e},n}function SelectBox(){var e=document.createElement("select");return e.addOption=function(t,a){let n=document.createElement("option");n.innerHTML=t,n.setAttribute("value",a||t),e.appendChild(n)},e}function toogleDungeonMQ(e){if(e&&data.dungeons[e].hasmq){let t=!SaveState.read("mq",e,!1);SaveState.write("mq",e,t),updateItems(),document.getElementById("dungeon_"+e).click()}}function addBadge(e,t,a){let n=document.createElement("span");switch(n.className=t||a?"hint-badge":"hint-badge empty-hint",t){case"child":n.innerHTML+="C";break;case"adult":n.innerHTML+="A"}switch(a){case"night":n.innerHTML+="N";break;case"day":n.innerHTML+="D"}if(!e)return n.outerHTML;e.appendChild(n)}function addPOIs(e,t){for(let a in data[t]){let n=document.createElement("span"),i=data[t][a];n.style.color="black",n.id=a,n.setAttribute("data-category",t),n.onclick=togglePOI,n.oncontextmenu=untogglePOI,n.style.left=i.x,n.style.top=i.y,i.mode&&n.setAttribute("data-mode",i.mode),new Tooltip(n,translate(a)+(addBadge(!1,i.age,i.time)||""),document.getElementById("viewpane")),poi[t].push(n),e.appendChild(n)}}function populateMap(){let e=document.getElementById("map");fillDungeonList(),addPOIs(e,"chests");for(let t in data.dungeons){let a=data.dungeons[t];s=document.createElement("span"),s.id="dungeon_"+t,s.onclick=clickDungeon,s.style.left=data.dungeons[t].x,s.style.top=data.dungeons[t].y;let n=document.createElement("span");n.className="count",s.appendChild(n),new Tooltip(s,translate(t)+(addBadge(!1,a.age,a.time)||""),document.getElementById("viewpane")),poi.dungeons.push(s),e.appendChild(s)}createShops(),createSongs(),createHints(),addPOIs(e,"skulltulas"),updateMap()}function createHints(){let e=document.getElementById("hint-view-body");data.hints.stones.sort(compareByTranslation),data.hints.locations.sort(compareByTranslation),data.hints.items.sort(compareByTranslation);for(let t=0;t<data.hints.stones.length;++t){let a=data.hints.stones[t],n=document.createElement("div");n.className="stone";let i=document.createElement("div");i.className="stone-title",i.innerHTML=translate(a);let s=document.createElement("div");s.className="stone-body",s.id="stonelist_"+a;let o=document.createElement("label");o.innerHTML=translate("location");let l=new SelectBox;l.id="stonelist_location_"+a,l.addOption("["+translate("empty")+"]","0x01"),l.addOption("["+translate("junk")+"]","0x02");for(let e=0;e<data.hints.locations.length;++e){let t=data.hints.locations[e];l.addOption(translate(t),t)}l.setAttribute("data-ref",a),l.onchange=saveHintChange,o.appendChild(l);let r=document.createElement("label");r.innerHTML=translate("item");let d=new SelectBox;d.id="stonelist_item_"+a,d.addOption("["+translate("empty")+"]","0x01");for(let e=0;e<data.hints.items.length;++e){let t=data.hints.items[e];d.addOption(translate(t),t)}d.setAttribute("data-ref",a),d.onchange=saveHintChange,r.appendChild(d),s.appendChild(o),s.appendChild(r),n.appendChild(i),n.appendChild(s),e.appendChild(n)}}function saveHintChange(e){let t=e.target,a=t.getAttribute("data-ref"),n=SaveState.read("hints",a,{location:"0x01",item:"0x01"});n[t.id.split("_")[1]]=t.value,SaveState.write("hints",a,n)}function rebuildAllHints(){for(let e in data.hints.stones){let t=data.hints.stones[e],a=SaveState.read("hints",t,{location:"0x01",item:"0x01"});document.getElementById("stonelist_location_"+t).value=a.location,document.getElementById("stonelist_item_"+t).value=a.item}}function createSongs(){let e=document.getElementById("song-view-body");for(let i in data.songs){let s=data.songs[i],o=document.createElement("div");o.className="song";let l=document.createElement("div");l.className="song-title",l.innerHTML=translate(i);let r=document.createElement("div");r.className="song-body stave",r.id="songlist_"+i;var t=SaveState.read("songs",i,s.notes);for(let e=0;e<t.length;++e){var a=s.notes[e],n=document.createElement("div");n.className="note note_"+a,r.appendChild(n)}if(s.editable){let e=document.createElement("button");e.className="song-edit",e.innerHTML="✎",e.onclick=editSong,e.setAttribute("data-ref",i),l.appendChild(e)}o.appendChild(l),o.appendChild(r),e.appendChild(o)}}function rebuildAllSongs(){for(let e in data.songs)rebuildSong(e)}function rebuildSong(e){let t=document.getElementById("songlist_"+e);t.innerHTML="";var a=SaveState.read("songs",e,data.songs[e].notes);for(let e=0;e<a.length;++e){let n=a[e],i=document.createElement("div");i.className="note note_"+n,t.appendChild(i)}}function editSong(e){let t=e.currentTarget.getAttribute("data-ref"),a=new SongBuilder(SaveState.read("songs",t,data.songs[t].notes)),n=new Dialog(function(e){if(e){let e=a.getSong();SaveState.write("songs",t,e),rebuildSong(t)}});n.setTitle(translate(t)),n.setSubmitText("SUBMIT"),n.setAbortText("CANCEL"),n.addElement(a)}function createShops(){let e=document.getElementById("shop-view-body");for(let t in data.shops){let a=data.shops[t],n=document.createElement("div");n.className="shop";let i=document.createElement("div");i.className="shop-title",i.innerHTML=translate(t);let s=document.createElement("div");s.className="shop-body",s.id=t;for(let e=0;e<a.length;++e){let n=a[e],i=data.shop_items[n.item],o=document.createElement("div");o.setAttribute("data-shop",t),o.setAttribute("data-slot",e),o.onclick=clickShopItem,o.oncontextmenu=clickShopReItem,o.className="shop-item";let l=document.createElement("div");l.className="shop-item-image",l.style.backgroundImage="url('images/"+i.image+"')",o.appendChild(l);let r=document.createElement("div");r.innerHTML=translate(n.item)+(i.refill?"":" "+translate("special_deal")),r.className="shop-item-title",o.appendChild(r);let d=document.createElement("div");d.innerHTML=n.price,d.className="shop-item-price",o.appendChild(d),s.appendChild(o)}let o=document.createElement("button");o.className="shop-edit",o.innerHTML="✎",o.onclick=editShop,o.setAttribute("data-ref",t),i.appendChild(o),n.appendChild(i),n.appendChild(s),e.appendChild(n)}}function clickShopItem(e){let t=e.currentTarget,a=t.getAttribute("data-shop"),n=t.getAttribute("data-slot"),i=SaveState.read("shops_bought",a,[0,0,0,0,0,0,0,0]);i[n]=1,SaveState.write("shops_bought",a,i),rebuildShop(a)}function clickShopReItem(e){let t=e.currentTarget,a=t.getAttribute("data-shop"),n=t.getAttribute("data-slot"),i=SaveState.read("shops_bought",a,[0,0,0,0,0,0,0,0]);i[n]=0,SaveState.write("shops_bought",a,i),rebuildShop(a)}function rebuildAllShops(){for(let e in data.shops)rebuildShop(e)}function rebuildShop(e){let t=document.getElementById(e).querySelectorAll(".shop-item"),a=SaveState.read("shops",e,data.shops[e]),n=SaveState.read("shops_bought",e,[0,0,0,0,0,0,0,0]);for(let e=0;e<8;++e){let i=a[e],s=data.shop_items[i.item],o=t[e];s.refill||!n[e]?o.querySelector(".shop-item-image").style.backgroundImage="url('images/"+s.image+"')":o.querySelector(".shop-item-image").style.backgroundImage="url('images/sold_out.png')",o.querySelector(".shop-item-title").innerHTML=translate(i.item)+(s.refill?"":" "+translate("special_deal")),o.querySelector(".shop-item-price").innerHTML=i.price}}function editShop(e){let t=e.currentTarget.getAttribute("data-ref"),a=(Object.keys(data.shop_items),new ShopBuilder(SaveState.read("shops",t,data.shops[t]))),n=new Dialog(function(e){e&&(SaveState.write("shops",t,a.getShop()),rebuildShop(t))});n.setTitle(translate(t)),n.setSubmitText("SUBMIT"),n.setAbortText("CANCEL"),n.addElement(a)}function togglePOI(e){let t=e.currentTarget.id,a=e.currentTarget.getAttribute("data-category");return SaveState.write(a,t,!0),updateMap(),e.preventDefault(),!1}function untogglePOI(e){let t=e.currentTarget.id,a=e.currentTarget.getAttribute("data-category");return SaveState.write(a,t,!1),updateMap(),e.preventDefault(),!1}function clickDungeon(e){loadDungeonList(e.currentTarget.id.slice(8))}function loadDungeonList(e){let t=e;"string"!=typeof t&&(t=e.currentTarget.getAttribute("data-ref"));let a=document.getElementById("dungeon-name");poi_list.ref=t,a.ref=t,a.innerHTML=translate(poi_list.ref);let n;if("overworld"==t)n=data[poi_list.mode],a.removeAttribute("data-mode");else{let e=data.dungeons[poi_list.ref];if(e.hasmq){let i=SaveState.read("mq",t,!1);a.setAttribute("data-mode",i?"mq":"v"),(n=e[poi_list.mode+(i?"_mq":"")])||(n=e[poi_list.mode])}else n=e[poi_list.mode],a.removeAttribute("data-mode")}fillDungeonList(n)}function fillDungeonList(e){let t=document.getElementById("dungeon-list");if(t.innerHTML="",poi_list.entries=[],e){let a=document.createElement("li"),n=document.createElement("span");n.className="hint-name",n.innerHTML="(back)",a.appendChild(n),addBadge(a),a.className="dungeon-entry",a.onclick=function(){fillDungeonList(),document.getElementById("dungeon-name").removeAttribute("data-mode")},a.style.cursor="pointer",t.appendChild(a);for(let a in e){let n=e[a],i=document.createElement("li");i.id=a;let s=document.createElement("span");s.className="hint-name",s.innerHTML=translate(a),i.appendChild(s),addBadge(i,n.age,n.time),i.setAttribute("data-category",poi_list.mode),i.onclick=togglePOI,i.oncontextmenu=untogglePOI,i.style.cursor="pointer",n.mode&&i.setAttribute("data-mode",n.mode),poi_list.entries.push(i),t.appendChild(i)}}else{let a=document.getElementById("dungeon-name");poi_list.ref="",a.ref=null,a.innerHTML="Hyrule";let n=document.createElement("li"),i=document.createElement("span");i.className="hint-name",i.innerHTML="Overworld",n.appendChild(i),addBadge(n),n.setAttribute("data-ref","overworld"),n.onclick=loadDungeonList,n.style.cursor="pointer",n.className="dungeon-entry DCAvailable",poi_list.entries.push(n),t.appendChild(n),e=data.dungeons;for(let a in e){let n=e[a],i=document.createElement("li"),s=document.createElement("span");s.className="hint-name",s.innerHTML=translate(a),i.appendChild(s),addBadge(i,n.age,n.time),i.setAttribute("data-ref",a),i.onclick=loadDungeonList,i.style.cursor="pointer",i.className="dungeon-entry DCAvailable",poi_list.entries.push(i),t.appendChild(i)}}updateMap()}function reloadDungeonList(){poi_list.ref&&poi_list.ref.length?loadDungeonList(poi_list.ref):updateMap()}function updateMap(){let e=0,t=0,a=0,n=0;for(let a=0;a<poi.chests.length;++a){let n=poi.chests[a];if(SaveState.read("chests",n.id,0))n.className="poi chest opened";else{let a=checkLogic("chests",n.id);n.className="poi chest "+(a?"available":"unavailable"),data.chests[n.id].mode&&"scrubsanity"==data.chests[n.id].mode&&!SaveState.read("options","scrubsanity",!1)||(t++,a&&e++)}}for(let i=0;i<poi.dungeons.length;++i){let s=poi.dungeons[i],o=s.id.slice(8);s.className="poi dungeon "+checkList(poi_list.mode,o);let l=data.dungeons[o].chests,r=data.dungeons[o].skulltulas;data.dungeons[o].hasmq&&SaveState.read("mq",o,!1)&&(l=data.dungeons[o].chests_mq,r=data.dungeons[o].skulltulas_mq);let d=0;for(let e in l)SaveState.read("chests",e,0)||l[e].mode&&"scrubsanity"==l[e].mode&&!SaveState.read("options","scrubsanity",!1)||(t++,checkLogic("chests",e)&&d++);e+=d;let c=0;for(let e in r)SaveState.read("skulltulas",e,0)||(checkLogic("skulltulas",e)&&c++,n++);if(a+=c,"chests"==poi_list.mode){let e=s.children[0];e.innerHTML=0==d?"":d}else if("skulltulas"==poi_list.mode){let e=s.children[0];e.innerHTML=0==c?"":c}}for(let e=0;e<poi.skulltulas.length;++e){let t=poi.skulltulas[e];if(SaveState.read("skulltulas",t.id,0))t.className="poi skulltula opened";else{let e=checkLogic("skulltulas",t.id);e&&a++,t.className="poi skulltula "+(e?"available":"unavailable"),n++}}let i=document.getElementById("dungeon-name");"chests"==poi_list.mode&&""!=poi_list.ref?i.className="DC"+checkBeatList(poi_list.ref):i.className="DCavailable";for(let e=0;e<poi_list.entries.length;++e){let t=poi_list.entries[e];if(SaveState.read(poi_list.mode,t.id,0))t.className="dungeon-entry DCopened";else{let e=t.getAttribute("data-ref");e?t.className="dungeon-entry DC"+checkList(poi_list.mode,e):(e=t.id,checkLogic(poi_list.mode,e)?t.className="dungeon-entry DCavailable":t.className="dungeon-entry DCunavailable")}}setStatus("chests-available",e),setStatus("chests-missing",t),setStatus("skulltulas-available",a),setStatus("skulltulas-missing",n)}function toggleStateButtons(){""==stateChoice.value?(stateSave.disabled=!0,stateLoad.disabled=!0,stateDel.disabled=!0,stateExport.disabled=!0,stateRename.disabled=!0):(stateChoice.value==activestate?stateSave.disabled=!1:stateSave.disabled=!0,stateLoad.disabled=!1,stateDel.disabled=!1,stateExport.disabled=!1,stateRename.disabled=!1)}function prepairSavegameChoice(){stateChoice.innerHTML='<option disabled selected hidden value=""> -- select state -- </option>';for(var e=Storage.names("save"),t=0;t<e.length;++t){var a=document.createElement("option");a.id=e[t],a.innerHTML=a.id,stateChoice.appendChild(a)}stateChoice.value=activestate}async function state_Save(){""!=stateChoice.value&&(stateChoice.value=activestate,saveNotes(),SaveState.save(activestate),await Dialog.alert("Success",'Saved "'+activestate+'" successfully.'))}async function state_Load(){if(""!=stateChoice.value){var e=!0;""!=activestate&&(e=await Dialog.confirm("Warning","Do you really want to load? Unsaved changes will be lost.")),e&&(activestate=stateChoice.value,SaveState.load(activestate),resetSettingsPage("options",document.getElementById("settings-options")),resetSettingsPage("skips",document.getElementById("settings-skips")),loadNotes(),updateItems(),rebuildAllShops(),rebuildAllSongs(),rebuildAllHints(),applySettingsChoices(),updateMap(),toggleStateButtons(),await Dialog.alert("Success",'State "'+activestate+'" loaded.'))}}async function state_Delete(){if(""!=stateChoice.value&&await Dialog.confirm("Warning",'Do you really want to delete "'+stateChoice.value+'"?')){var e=stateChoice.value;Storage.remove("save",e),e!=activestate&&(updateItems(),updateMap()),stateChoice.value=activestate,prepairSavegameChoice(),toggleStateButtons(),await Dialog.alert("Success",'State "'+e+'" removed.')}}async function state_New(){var e=await Dialog.prompt("New state","Please enter a new name! (Unsaved changes will be lost.)");if(!1!==e){if(""==e)return await Dialog.alert("Warning","The name can not be empty."),void state_New();if(Storage.has("save",e))return await Dialog.alert("Warning","The name already exists."),void state_New();""==activestate?await Dialog.confirm("Success",'State "'+e+'" created.<br>Do you want to reset the current state?')&&SaveState.reset():(await Dialog.alert("Success",'State "'+e+'" created.'),SaveState.reset()),SaveState.save(e),stateChoice.value=e,activestate=e,resetSettingsPage("options",document.getElementById("settings-options")),resetSettingsPage("skips",document.getElementById("settings-skips")),prepairSavegameChoice(),loadNotes(),updateItems(),rebuildAllShops(),rebuildAllSongs(),rebuildAllHints(),applySettingsChoices(),toggleStateButtons()}}async function state_Rename(){if(""!=stateChoice.value&&await Dialog.confirm("Warning",'Do you really want to rename "'+stateChoice.value+'"?')){var e=await Dialog.prompt("New state","Please enter a new name!");if(!1!==e){if(""==e)return await Dialog.alert("Warning","The name can not be empty."),void state_New();if(Storage.has("save",e))return await Dialog.alert("Warning","The name already exists."),void state_New();var t=Storage.get("save",stateChoice.value);Storage.remove("save",stateChoice.value),Storage.set("save",e,t),prepairSavegameChoice(),""!=activestate&&activestate==stateChoice.value&&(activestate=e),stateChoice.value=e,toggleStateButtons()}}}async function state_Export(){if(""!=stateChoice.value){var e=!0;if(""!=activestate&&(e=await Dialog.confirm("Are you shure?","The last saved state will be exported.")),e){var t={name:stateChoice.value,data:Storage.get("save",stateChoice.value)};await Dialog.alert("Your export string",btoa(JSON.stringify(t)).replace(/=*$/,""))}}}async function state_Import(){var e=await Dialog.prompt("Import","Please enter export string!");if(!1!==e){if(""==e)return await Dialog.alert("Warning","The import string can not be empty."),void state_Import();if(e=JSON.parse(atob(e)),Storage.has("save",e.name)&&!await Dialog.confirm("Warning","There is already a savegame with this name. Replace savegame?."))return;Storage.set("save",e.name,e.data),prepairSavegameChoice(),await Dialog.confirm('Imported "'+e.name+'" successfully.',"Do you want to load the imported state?"+(""==activestate?"":" Unsaved changes will be lost."))&&(stateChoice.value=e.name,activestate=e.name,SaveState.load(activestate),updateItems(),applySettingsChoices(),toggleStateButtons())}}function generateSettingsPage(e,t){for(let l in data.rom_options[e]){var a=document.createElement("label"),n=data.rom_options[e][l];a.className="settings-option";var i=document.createElement("span");i.innerHTML=translate(l),i.className="option-text",a.appendChild(i);var s;switch(n.type){case"check":(s=document.createElement("input")).className="settings-input",s.setAttribute("type","checkbox"),s.checked=SaveState.read(e,l,n.default);break;case"choice":(s=document.createElement("select")).className="settings-input";for(let e in n.values){var o=document.createElement("option");o.innerHTML=translate(n.values[e]),o.setAttribute("value",n.values[e]),s.appendChild(o)}s.value=SaveState.read(e,l,n.default)}s.setAttribute("data-ref",l),a.appendChild(s),t.appendChild(a)}}function resetSettingsPage(e,t){var a=Array.from(t.querySelectorAll(".settings-option"));for(let t in a){var n=a[t].querySelector(".settings-input"),i=n.getAttribute("data-ref"),s=data.rom_options[e][i];switch(n.nodeName){case"INPUT":n.checked=SaveState.read(e,i,s.default);break;case"SELECT":n.value=SaveState.read(e,i,s.default)}}}function readSettingsPage(e,t){var a=Array.from(t.querySelectorAll(".settings-option"));for(let t in a){var n=a[t].querySelector(".settings-input"),i=n.getAttribute("data-ref");switch(n.nodeName){case"INPUT":SaveState.write(e,i,n.checked);break;case"SELECT":SaveState.write(e,i,n.value)}}}function buildSettings(){var e=document.getElementById("edit-settings"),t=document.getElementById("settings-cancel"),a=document.getElementById("settings-save"),n=document.getElementById("settings"),i=document.getElementById("settings-options"),s=document.getElementById("settings-skips"),o=n.querySelector("#font"),l=n.querySelector("#layout"),r=n.querySelector("#item-scale-slider"),d=n.querySelector("#show_hint_badges"),c=n.querySelector("#use_custom_logic");r.addEventListener("input",function(e){n.querySelector("#item-scale-slider+.input-value").innerHTML=e.currentTarget.value+"px"}),e.addEventListener("click",function(){n.classList.add("active")}),t.addEventListener("click",function(){o.value=Storage.get("settings","font",""),l.value=Storage.get("settings","layout","map-compact"),r.value=Storage.get("settings","itemsize",40),d.checked=Storage.get("settings","show_hint_badges",!1),c.checked=Storage.get("settings","use_custom_logic",!1),resetSettingsPage("options",i),resetSettingsPage("skips",s),n.classList.remove("active")}),a.addEventListener("click",function(){Storage.set("settings","use_custom_logic",c.checked),Storage.set("settings","show_hint_badges",d.checked),Storage.set("settings","font",o.value),Storage.set("settings","layout",l.value),Storage.set("settings","itemsize",r.value),readSettingsPage("options",i),readSettingsPage("skips",s),applySettingsChoices(),reloadDungeonList(),updateMap(),data.logic_patched=Storage.get("settings","logic",{}),document.getElementById("settings").classList.remove("active")});Array.from(n.querySelectorAll(".card-button")).forEach(function(e){e.addEventListener("click",function(e){if(!e.target.classList.contains("disabled")){Array.from(n.querySelectorAll(".card-body, .card-button")).forEach(function(e){e.classList.remove("active")});n.querySelector("#"+e.target.getAttribute("data-target")).classList.add("active"),e.target.classList.add("active")}})}),generateSettingsPage("options",i),generateSettingsPage("skips",s),o.value=Storage.get("settings","font",""),l.value=Storage.get("settings","layout","map-compact"),r.value=Storage.get("settings","itemsize",40),d.checked=Storage.get("settings","show_hint_badges",!1),c.checked=Storage.get("settings","use_custom_logic",!1),applySettingsChoices()}function applySettingsChoices(){document.getElementById("viewpane").setAttribute("data-font",Storage.get("settings","font",""));var e=document.querySelector(".layout-container[data-layout]");e.setAttribute("data-layout",Storage.get("settings","layout","map-compact")),e.style.setProperty("--item-size",Storage.get("settings","itemsize",40)),Storage.get("settings","show_hint_badges",!1)?document.body.setAttribute("data-hint-badges","true"):document.body.setAttribute("data-hint-badges","false"),SaveState.read("options","scrubsanity",!1)?document.body.setAttribute("data-scrubsanity","true"):document.body.setAttribute("data-scrubsanity","false")}function saveNotes(){SaveState.write("extra","notes",document.getElementById("tracker-notes").value)}function loadNotes(){document.getElementById("tracker-notes").value=SaveState.read("extra","notes","")}function changeItemInactiveEffect(){var e=parseInt(document.getElementById("item-container").getAttribute("data-inactive"))||0;++e>2&&(e=0),document.getElementById("item-container").setAttribute("data-inactive",e)}async function main(){document.getElementById("status-version").innerHTML=await fetch("version").then(e=>e.ok?e.text():"dev"),data=await loadAll(),map_scale_slider.value=Storage.get("settings","map_zoom",90),document.getElementById("map").style.setProperty("--map-scale",parseInt(map_scale_slider.value)/100),buildSettings(),prepairSavegameChoice(),createItemTracker(),populateMap(),Splash.hide()}function translate(e){return data.lang[e]?data.lang[e]:e}function compareByTranslation(e,t){let a=translate(e),n=translate(t);return translate(a)<translate(n)?-1:translate(a)>translate(n)?1:0}function setStatus(e,t){document.getElementById("status-"+e).innerHTML=t}!function(){function e(){var e="dialog_"+ ++a,t={container:document.createElement("DIV"),window:document.createElement("DIV"),focusCT:document.createElement("DIV"),focusCB:document.createElement("DIV"),title:document.createElement("DIV"),text:document.createElement("DIV"),body:document.createElement("DIV"),footer:document.createElement("DIV"),submit:document.createElement("BUTTON"),abort:document.createElement("BUTTON"),close:document.createElement("button")};return t.close.className="dialog-close",t.close.setAttribute("title","close"),t.submit.className="hidden",t.submit.setAttribute("type","submit"),t.abort.className="hidden",t.abort.setAttribute("type","reset"),t.title.id=e+"_title",t.title.className="dialog-title hidden",t.text.id=e+"_text",t.text.className="dialog-text hidden",t.body.className="dialog-body",t.body.appendChild(t.text),t.footer.className="dialog-footer",t.footer.appendChild(t.submit),t.footer.appendChild(t.abort),t.focusCT.setAttribute("tabindex","0"),t.focusCB.setAttribute("tabindex","0"),t.window.className="dialog-window",t.window.id=e,t.window.setAttribute("role","dialog"),t.window.setAttribute("aria-modal","true"),t.window.appendChild(t.title),t.window.appendChild(t.body),t.window.appendChild(t.footer),t.window.appendChild(t.close),t.container.className="dialog",t.container.appendChild(t.focusCT),t.container.appendChild(t.window),t.container.appendChild(t.focusCB),t}const t=['button:not([tabindex="-1"])','[href]:not([tabindex="-1"])','input:not([tabindex="-1"])','select:not([tabindex="-1"])','textarea:not([tabindex="-1"])','[tabindex]:not([tabindex="-1"])'].join(",");var a=0;window.Dialog=function(a,n){function i(e){"function"==typeof a&&a(!!e),document.body.removeChild(s.container),n&&n.focus()}var s=e(),o=[];s.focusCT.onfocus=function(){o.length&&o[o.length-1].focus()},s.focusCB.onfocus=function(){o.length&&o[0].focus()},s.container.onkeydown=function(e){27==(e.which||e.keyCode)&&i(),e.stopPropagation()},s.submit.onclick=function(){i(!0)},s.abort.onclick=function(){i()},s.close.onclick=function(){i()},this.setTitle=function(e){return void 0===e?(s.title.classList.add("hidden"),target.removeAttribute("aria-labelledby")):(s.title.classList.remove("hidden"),s.title.innerHTML=e,s.window.setAttribute("aria-labelledby",s.title.id)),this},this.setText=function(e){return void 0===e?(s.text.classList.add("hidden"),target.removeAttribute("aria-describedby")):(s.text.classList.remove("hidden"),s.text.innerHTML=e,s.window.setAttribute("aria-describedby",s.text.id)),this},this.setSubmitText=function(e){return s.submit.classList.remove("hidden"),s.submit.innerHTML=e.toUpperCase(),s.submit.setAttribute("title",e),(o=Array.from(s.window.querySelectorAll(t)))[0].focus(),this},this.setAbortText=function(e){return s.abort.classList.remove("hidden"),s.abort.innerHTML=e.toUpperCase(),s.abort.setAttribute("title",e),(o=Array.from(s.window.querySelectorAll(t)))[0].focus(),this},this.setCloseText=function(e){return s.close.setAttribute("title",e),tab_btns.push(s.close),this},this.addElement=function(e){return s.body.appendChild(e),(o=Array.from(s.window.querySelectorAll(t)))[0].focus(),this},(o=Array.from(s.window.querySelectorAll(t)))[0].focus(),document.body.appendChild(s.container)},Dialog.alert=function(e,t,a){return new Promise(function(n){new Dialog(n,a).setTitle(e).setText(t).setSubmitText("OK")})},Dialog.confirm=function(e,t,a){return new Promise(function(n){new Dialog(n,a).setTitle(e).setText(t).setSubmitText("YES").setAbortText("NO")})},Dialog.prompt=function(e,t,a){return new Promise(function(n){var i=document.createElement("input");i.className="dialog-input",new Dialog(function(e){n(!!e&&i.value)},a).setTitle(e).setText(t).setSubmitText("SUBMIT").setAbortText("CANCEL").addElement(i)})}}(),window.SaveState=new function(){var e={};this.save=function(t){Storage.set("save",t,e)},this.load=function(t){e=Storage.get("save",t)},this.write=function(t,a,n){e[t]=e[t]||{},e[t][a]=n},this.read=function(t,a,n){return e.hasOwnProperty(t)&&e[t].hasOwnProperty(a)?e[t][a]:n},this.reset=function(){e={}}},window.Storage=new function(){this.set=function(e,t,a){localStorage.setItem(e+"\0"+t,JSON.stringify(a))},this.get=function(e,t,a=null){try{var n=localStorage.getItem(e+"\0"+t);return n&&null!=n?JSON.parse(n):a}catch(e){return a}},this.has=function(e,t){return localStorage.hasOwnProperty(e+"\0"+t)},this.remove=function(e,t){localStorage.removeItem(e+"\0"+t)},this.categories=function(){var e=Object.keys(localStorage);return Array.from(new Set(e.map(function(e){return e.split("\0")[0]})))},this.names=function(e){var t=Object.keys(localStorage);return Array.from(new Set(t.filter(function(t){return t.startsWith(e+"\0")}).map(function(e){return e.split("\0")[1]})))}},window.FileLoader=new function(){var e=0,t=0;this.onupdate=null,this.addFont=function(a,n,i="normal",s=400){e++,"function"==typeof this.onupdate&&this.onupdate(e,t);var o=new FontFace(a,"url("+n+")",{style:i,weight:s});return document.fonts.add(o),o.loaded.then(function(a){return t++,"function"==typeof this.onupdate&&this.onupdate(e,t),a}.bind(this))},this.loadText=function(a){return e++,"function"==typeof this.onupdate&&this.onupdate(e,t),fetch(new Request(a,{method:"GET",headers:new Headers({"Content-Type":"text/plain",Pragma:"no-cache","Cache-Control":"no-cache"}),mode:"cors",cache:"default"})).then(function(a){return t++,"function"==typeof this.onupdate&&this.onupdate(e,t),a.text()}.bind(this))},this.loadAllText=function(e){var t=[];for(let a in e)t.push(this.loadText(e[a]));return Promise.all(t)},this.loadJSON=function(a){return e++,"function"==typeof this.onupdate&&this.onupdate(e,t),fetch(new Request(a,{method:"GET",headers:new Headers({"Content-Type":"application/json",Pragma:"no-cache","Cache-Control":"no-cache"}),mode:"cors",cache:"default"})).then(function(a){return t++,"function"==typeof this.onupdate&&this.onupdate(e,t),a.json()}.bind(this))},this.loadAllJSON=function(e){var t=[];for(let a in e)t.push(this.loadJSON(e[a]));return Promise.all(t)}};var itemGridEls=[];let poi={chests:[],dungeons:[],skulltulas:[]},poi_list={mode:"chests",ref:"",entries:[]},map=new Map(document.getElementById("map-scroll"),"../images/map.png",825,466);document.getElementById("dungeon-name").addEventListener("click",function(e){toogleDungeonMQ(e.currentTarget.ref)}),document.getElementById("dungeon-switch").addEventListener("click",function(e){poi_list.mode="chests"==poi_list.mode?"skulltulas":"chests",e.currentTarget.setAttribute("data-mode",poi_list.mode),document.getElementById("map-container").setAttribute("data-mode",poi_list.mode),reloadDungeonList()});var activestate="",stateChoice=document.getElementById("select-savegame"),stateSave=document.getElementById("save-savegame"),stateLoad=document.getElementById("load-savegame"),stateNew=document.getElementById("new-savegame"),stateDel=document.getElementById("delete-savegame"),stateRename=document.getElementById("rename-savegame"),stateExport=document.getElementById("export-savegame"),stateImport=document.getElementById("import-savegame");stateSave.addEventListener("click",state_Save),stateLoad.addEventListener("click",state_Load),stateNew.addEventListener("click",state_New),stateDel.addEventListener("click",state_Delete),stateRename.addEventListener("click",state_Rename),stateExport.addEventListener("click",state_Export),stateImport.addEventListener("click",state_Import),stateChoice.addEventListener("change",toggleStateButtons);var data={},map_scale_slider=document.getElementById("map-scale-slider");map_scale_slider.addEventListener("input",function(e){document.getElementById("map").style.setProperty("--map-scale",parseInt(map_scale_slider.value)/100)}),map_scale_slider.addEventListener("change",function(e){document.getElementById("map").style.setProperty("--map-scale",parseInt(map_scale_slider.value)/100),Storage.set("settings","map_zoom",parseInt(map_scale_slider.value))}),document.getElementById("map-option-shops").addEventListener("click",function(e){document.getElementById("shop-view").classList.add("active")}),document.getElementById("shop-view-close-button").addEventListener("click",function(e){document.getElementById("shop-view").classList.remove("active")}),document.getElementById("map-option-songs").addEventListener("click",function(e){document.getElementById("song-view").classList.add("active")}),document.getElementById("song-view-close-button").addEventListener("click",function(e){document.getElementById("song-view").classList.remove("active")}),document.getElementById("map-option-hints").addEventListener("click",function(e){document.getElementById("hint-view").classList.add("active")}),document.getElementById("hint-view-close-button").addEventListener("click",function(e){document.getElementById("hint-view").classList.remove("active")}),document.getElementById("map-option-notes").addEventListener("click",function(e){document.getElementById("notes-view").classList.add("active")}),document.getElementById("notes-view-close-button").addEventListener("click",function(e){document.getElementById("notes-view").classList.remove("active")}),window.onfocus=function(e){data.logic_patched=Storage.get("settings","logic",{}),updateMap()},window.oncontextmenu=function(e){return e.preventDefault(),!1},main(),document.getElementById("erase_all_data").onclick=function(){Dialog.prompt("Erase all data?",'You are about to erase all data.<br>Please enter "ERAZE" to continue.<br><br>Warning: This cant be undone!').then(function(e){"ERAZE"===e&&(window.location="uninstall.html")})};