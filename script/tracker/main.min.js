async function loadAll(){var e=await FileLoader.loadAllJSON(["database/items.json","database/grids.json","database/chests.json","database/dungeons.json","database/skulltulas.json","database/logic.json","database/rom_options.json","database/shops.json","database/shop_items.json","database/lang_en.json"]),t={};return t.items=e.shift(),t.grids=e.shift(),t.chests=e.shift(),t.dungeons=e.shift(),t.skulltulas=e.shift(),t.logic=e.shift(),t.logic_patched=Storage.get("settings","logic",{}),t.rom_options=e.shift(),t.shops=e.shift(),t.shop_items=e.shift(),t.lang=e.shift(),t}function checkLogicObject(e){if(!e||null==e)return!0;switch(e.type){case"and":if(!e.el.length)return!0;for(let a=0;a<e.el.length;++a){if((t=e.el[a])&&null!=t&&!checkLogicObject(t))return!1}return!0;case"or":if(!e.el.length)return!0;for(let a=0;a<e.el.length;++a){var t=e.el[a];if(t&&null!=t&&checkLogicObject(t))return!0}return!1;case"not":return!checkLogicObject(e.el);case"equal":return checkLogicObject(e.el)==e.value;case"value":case"min":return checkLogicObject(e.el)>=e.value;case"mixin":return checkLogic("mixins",e.el);case"skip":a=SaveState.read("skips",e.el,data.rom_options.skips[e.el].default);return e.hasOwnProperty("value")?a==e.value:a;case"setting":case"option":var a=SaveState.read("options",e.el,data.rom_options.options[e.el].default);return e.hasOwnProperty("value")?a==e.value:a;case"item":return SaveState.read("items",e.el,0);default:return!1}}function checkLogicArray(e){if(0==e.length)return!0;e:for(var t=0;t<e.length;++t){for(var a=e[t],n=0;n<a.length;++n){var i=a[n],s=!0;i.startsWith("!")&&(s=!1,i=i.slice(1));var[o,r]=i.split(":");o=o.split(".");var l=SaveState.read(o[0],o[1],0);if(r){if(l<r==s)continue e}else if(!l==s)continue e}return!0}return!1}function getLogic(e,t){return Storage.get("settings","use_custom_logic",!1)&&data.logic_patched.hasOwnProperty(e)&&data.logic_patched[e].hasOwnProperty(t)?data.logic_patched[e][t]:data.logic.hasOwnProperty(e)||data.logic[e].hasOwnProperty(t)?data.logic[e][t]:void 0}function checkLogic(e,t){var a=getLogic(e,t);return void 0!==a&&(Array.isArray(a)?checkLogicArray(a):checkLogicObject(a))}function checkAvailable(e,t){return checkLogic(e,t)?"available":"unavailable"}function checkOpened(e,t){var a=data.dungeons[t][e];for(let t in a)if(!SaveState.read(e,t,0))return!1;return!0}function checkBeatList(e){var t=data.logic.dungeons[e];return Array.isArray(t)&&0==t.length||null==t?checkList("chests",e):checkOpened("chests",e)?"opened":checkLogic("dungeons",e)?"available":"unavailable"}function checkList(e,t){var a;a="overworld"==t?data[e]:data.dungeons[t].hasmq&&SaveState.read("mq",t,!1)?data.dungeons[t][e+"_mq"]:data.dungeons[t][e];var n=0,i=0;for(let t in a)a[t].mode&&"scrubsanity"==a[t].mode&&!SaveState.read("options","scrubsanity",!1)||SaveState.read(e,t,0)||(i++,checkLogic(e,t)&&n++);return 0==i?"opened":n==i?"available":0==n?"unavailable":"possible"}function Item(e,t){function a(){n.always_active||0!=i?s.classList.remove("item-inactive"):s.classList.add("item-inactive"),data.items[s.id].counting&&(Array.isArray(data.items[e].counting)?s.innerHTML=data.items[e].counting[i]:s.innerHTML=0==i?"":i),function(){if(data.items[e].hasOwnProperty("images")){let t=data.items[e].images;Array.isArray(t)?s.style.backgroundImage="url('images/"+t[i]+"')":"string"==typeof t&&(s.style.backgroundImage="url('images/"+t+"')")}}();var t=n.max;n.hasOwnProperty("related_dungeon")&&SaveState.read("mq",n.related_dungeon,!1)&&(t=n.maxmq||t),n.hasOwnProperty("mark")&&i>=n.mark||i>=t?s.classList.add("mark"):s.classList.remove("mark")}var n=data.items[e],i=SaveState.read("items",e,0),s=document.createElement("DIV");s.id=e,s.classList.add("item"),a(),s.onclick=function(t){var s=n.max;return n.hasOwnProperty("related_dungeon")&&SaveState.read("mq",n.related_dungeon,!1)&&(s=n.maxmq||s),i<s&&(SaveState.write("items",e,++i),a(),updateItems(),updateMap()),t.preventDefault(),!1},s.oncontextmenu=function(t){return i>0&&(SaveState.write("items",e,--i),a(),updateItems(),updateMap()),t.preventDefault(),!1},t.appendChild(s),this.update=function(){i=SaveState.read("items",e,0),a()}}function ToggleMQ(e,t){var a=SaveState.read("mq",e,!1),n=document.createElement("DIV");n.id=name,n.classList.add("switch"),n.innerHTML=a?"MQ":"V",n.onclick=function(t){return a=!a,SaveState.write("mq",e,a),n.innerHTML=a?"MQ":"V",reloadDungeonList(),t.preventDefault(),!1},t.appendChild(n),this.update=function(){a=SaveState.read("mq",e,!1),n.innerHTML=a?"MQ":"V"}}function ToggleReward(e,t){var a=[!1,"stone_forest","stone_fire","stone_water","medallion_forest","medallion_fire","medallion_water","medallion_spirit","medallion_shadow","medallion_light"],n=0,i=document.createElement("DIV");i.id=name,i.classList.add("switch"),i.onclick=function(t){return++n>=a.length&&(n=1),SaveState.write("rewards",e,n),i.innerHTML="",i.style.backgroundImage="url('images/"+data.items[a[n]].images+"')",t.preventDefault(),!1},i.oncontextmenu=function(t){return n=0,SaveState.write("rewards",e,n),i.innerHTML="?",i.style.backgroundImage="",t.preventDefault(),!1},t.appendChild(i),this.update=function(){n=SaveState.read("rewards",e,0),i.innerHTML=n?"":"?",i.style.backgroundImage=n?"url('images/"+data.items[a[n]].images+"')":""},this.update()}function DungeonStatus(e,t){function a(e){var t=document.createElement("DIV");return t.classList.add("text"),t.innerHTML=e,t}var n,i,s,o,r,l,d,c=document.createElement("DIV");c.classList.add("item-row"),t.appendChild(c),n=a(e.title),c.appendChild(n),e.keys?i=new Item(e.keys,c):c.appendChild(a("")),e.bosskey?s=new Item(e.bosskey,c):c.appendChild(a("")),e.map?o=new Item(e.map,c):c.appendChild(a("")),e.compass?r=new Item(e.compass,c):c.appendChild(a("")),e.boss_reward?l=new ToggleReward(e.ref,c):c.appendChild(a("")),e.hasmq?d=new ToggleMQ(e.ref,c):c.appendChild(a("")),this.update=function(){i&&i.update(),s&&s.update(),o&&o.update(),r&&r.update(),l&&l.update(),d&&d.update()}}function createItemTracker(){createGrid(document.getElementById("item-container"),data.grids.items),createGrid(document.getElementById("key-container"),data.grids.keys);for(var e=data.grids.dungeons,t=0;t<e.length;++t)itemGridEls.push(new DungeonStatus(e[t],document.getElementById("dungeon-status-container")))}function createGrid(e,t){for(let i=0;i<t.length;++i){var a=document.createElement("DIV");a.classList.add("item-row");var n=t[i];for(let e=0;e<n.length;++e){let t=n[e];t.startsWith("icon:")?createItemIcon(a,(t=t.split("#"))[0].slice(5),t[1]):t.startsWith("text:")?createItemText(a,(t=t.split("#"))[0].slice(5),t[1]):createItemButton(a,t)}e.appendChild(a)}}function createItemButton(e,t){itemGridEls.push(new Item(t,e))}function createItemIcon(e,t,a){var n=document.createElement("DIV");n.classList.add("icon"),a&&(n.id=a),n.style.backgroundImage="url('images/"+t+"')",e.appendChild(n)}function createItemText(e,t,a){var n=document.createElement("DIV");n.classList.add("text"),a&&(n.id=a),n.innerHTML=t,e.appendChild(n)}function toggleItem(e){var t=e.currentTarget,a=SaveState.read("items",t.id,0),n=data.items[t.id],i=n.max;return n.hasOwnProperty("related_dungeon")&&SaveState.read("mq",n.related_dungeon,!1)&&(i=n.maxmq||i),a<i&&(SaveState.write("items",t.id,++a),setVisual(t,a),updateMap()),e.preventDefault(),!1}function untoggleItem(e){var t=e.currentTarget,a=SaveState.read("items",t.id,0);data.items[t.id];return a>0&&(SaveState.write("items",t.id,--a),setVisual(t,a),updateMap()),e.preventDefault(),!1}function setVisual(e,t){var a=data.items[e.id];a.always_active||0!=t?e.classList.remove("item-inactive"):e.classList.add("item-inactive"),data.items[e.id].counting&&(Array.isArray(data.items[e.id].counting)?e.innerHTML=data.items[e.id].counting[t]:e.innerHTML=0==t?"":t),setImage(e,e.id,t);var n=a.max;a.hasOwnProperty("related_dungeon")&&SaveState.read("mq",a.related_dungeon,!1)&&(n=a.maxmq||n),a.hasOwnProperty("mark")&&t>=a.mark||t>=n?e.classList.add("mark"):e.classList.remove("mark")}function setImage(e,t,a){if(data.items[t].hasOwnProperty("images")){let n=data.items[t].images;Array.isArray(n)?e.style.backgroundImage="url('images/"+n[a]+"')":"string"==typeof n&&(e.style.backgroundImage="url('images/"+n+"')")}else e.style.backgroundImage="url('images/unknown.png')"}function updateItems(){for(var e=0;e<itemGridEls.length;++e)itemGridEls[e].update()}function Map(e,t,a,n){var i=document.createElement("div");i.id="map",i.style.backgroundImage='url("'+t+'")',i.style.width="calc("+a+"px * var(--map-scale))",i.style.height="calc("+n+"px * var(--map-scale))",e.appendChild(i)}function Tooltip(e,t){var a=document.createElement("div");a.className="tooltip",a.innerHTML=t,e.addEventListener("mouseover",function(e){document.body.appendChild(a);var t=document.documentElement.clientWidth,n=document.documentElement.clientHeight,i=e.pageX,s=e.pageY,o=a.clientWidth+40,r=a.clientHeight+20;s+20+r>=n?s-=r:s+=20,i+20+o>=t?i=t-o:i+=20,a.style.left=i+"px",a.style.top=s+"px"}),e.addEventListener("mouseout",function(e){document.body.removeChild(a)})}function toogleDungeonMQ(e){if(e&&data.dungeons[e].hasmq){var t=!SaveState.read("mq",e,!1);SaveState.write("mq",e,t),updateItems(),document.getElementById("dungeon_"+e).click()}}function addBadge(e,t,a){if(t||a){var n=document.createElement("span");switch(n.className="hint-badge",t){case"child":n.innerHTML+="C";break;case"adult":n.innerHTML+="A"}switch(a){case"night":n.innerHTML+="N";break;case"day":n.innerHTML+="D"}if(!e)return n.outerHTML;e.appendChild(n)}}function addPOIs(e,t){for(let i in data[t]){var a=document.createElement("span"),n=data[t][i];a.style.color="black",a.id=i,a.setAttribute("data-category",t),a.onclick=togglePOI,a.oncontextmenu=untogglePOI,a.style.left=n.x,a.style.top=n.y,n.mode&&a.setAttribute("data-mode",n.mode),new Tooltip(a,translate(i)+(addBadge(!1,n.age,n.time)||"")),poi[t].push(a),e.appendChild(a)}}function populateMap(){var e=document.getElementById("map");fillDungeonList(),addPOIs(e,"chests");for(let a in data.dungeons){s=document.createElement("span"),s.id="dungeon_"+a,s.onclick=clickDungeon,s.style.left=data.dungeons[a].x,s.style.top=data.dungeons[a].y;var t=document.createElement("span");t.className="count",s.appendChild(t),new Tooltip(s,translate(a)),poi.dungeons.push(s),e.appendChild(s)}createShops(),addPOIs(e,"skulltulas"),updateMap()}function createShops(){var e=document.getElementById("shop-view-body");for(let m in data.shops){var t=data.shops[m],a=document.createElement("div");a.className="shop";var n=document.createElement("div");n.className="shop-title",n.innerHTML=translate(m);var i=document.createElement("div");i.className="shop-body",i.id=m;for(let e=0;e<t.length;++e){var s=t[e],o=data.shop_items[s.item],r=document.createElement("div");r.onclick=new Function("clickShopItem('"+m+"','"+e+"')"),r.oncontextmenu=new Function("clickShopReItem('"+m+"','"+e+"')"),r.className="shop-item";var l=document.createElement("div");l.className="shop-item-image",l.style.backgroundImage="url('images/"+o.image+"')",r.appendChild(l);var d=document.createElement("div");d.innerHTML=translate(s.item)+(o.refill?"":" "+translate("special_deal")),d.className="shop-item-title",r.appendChild(d);var c=document.createElement("div");c.innerHTML=s.price,c.className="shop-item-price",r.appendChild(c),i.appendChild(r)}var u=document.createElement("button");u.className="shop-edit",u.innerHTML="✎",u.onclick=editShop,u.setAttribute("data-ref",m),n.appendChild(u),a.appendChild(n),a.appendChild(i),e.appendChild(a)}}function clickShopItem(e,t){var a=SaveState.read("shops_bought",e,[0,0,0,0,0,0,0,0]);a[t]=1,SaveState.write("shops_bought",e,a),rebuildShop(e)}function clickShopReItem(e,t){var a=SaveState.read("shops_bought",e,[0,0,0,0,0,0,0,0]);a[t]=0,SaveState.write("shops_bought",e,a),rebuildShop(e)}function rebuildAllShops(){for(let e in data.shops)rebuildShop(e)}function rebuildShop(e){var t=document.getElementById(e).querySelectorAll(".shop-item"),a=SaveState.read("shops",e,data.shops[e]),n=SaveState.read("shops_bought",e,[0,0,0,0,0,0,0,0]);for(let e=0;e<8;++e){var i=a[e],s=data.shop_items[i.item],o=t[e];s.refill||!n[e]?o.querySelector(".shop-item-image").style.backgroundImage="url('images/"+s.image+"')":o.querySelector(".shop-item-image").style.backgroundImage="url('images/sold_out.png')",o.querySelector(".shop-item-title").innerHTML=translate(i.item)+(s.refill?"":" "+translate("special_deal")),o.querySelector(".shop-item-price").innerHTML=i.price}}function editShop(e){var t=e.currentTarget.getAttribute("data-ref"),a=Object.keys(data.shop_items),n=SaveState.read("shops",t,data.shops[t]),i=[],s=[],o=document.createElement("div");o.className="shop";for(let e=0;e<8;++e){var r=document.createElement("div"),l=document.createElement("select"),d=document.createElement("input"),c=document.createElement("span");r.className="shop-item";for(let e=0;e<a.length;++e){var u=document.createElement("option");u.innerHTML=translate(a[e])+(data.shop_items[a[e]].refill?"":" "+translate("special_deal")),u.setAttribute("value",a[e]),l.appendChild(u)}l.value=n[e].item,l.className="shop-item-title",d.setAttribute("type","number"),d.setAttribute("min-value",1),d.setAttribute("max-value",999),d.value=n[e].price,d.className="shop-item-price",i.push(l),s.push(d),c.innerHTML="Rupee(s)",r.appendChild(l),r.appendChild(d),r.appendChild(c),o.appendChild(r)}var m=new Dialog(function(e){if(e){var a=[];for(let e=0;e<8;++e)a.push({item:i[e].value,price:s[e].value});SaveState.write("shops",t,a),rebuildShop(t)}});m.setTitle(translate(t)),m.setSubmitText("SUBMIT"),m.setAbortText("ABORT"),m.addElement(o)}function togglePOI(e){var t=e.currentTarget.id,a=e.currentTarget.getAttribute("data-category");return SaveState.write(a,t,!0),updateMap(),e.preventDefault(),!1}function untogglePOI(e){var t=e.currentTarget.id,a=e.currentTarget.getAttribute("data-category");return SaveState.write(a,t,!1),updateMap(),e.preventDefault(),!1}function clickDungeon(e){loadDungeonList(e.currentTarget.id.slice(8))}function loadDungeonList(e){var t=e;"string"!=typeof t&&(t=e.currentTarget.getAttribute("data-ref"));var a=document.getElementById("dungeon-name");poi_list.ref=t,a.ref=t,a.innerHTML=translate(poi_list.ref);var n;if("overworld"==t)n=data[poi_list.mode],a.removeAttribute("data-mode");else{var i=data.dungeons[poi_list.ref];if(i.hasmq){var s=SaveState.read("mq",t,!1);a.setAttribute("data-mode",s?"mq":"v"),(n=i[poi_list.mode+(s?"_mq":"")])||(n=i[poi_list.mode])}else n=i[poi_list.mode],a.removeAttribute("data-mode")}fillDungeonList(n)}function fillDungeonList(e){var t=document.getElementById("dungeon-list");if(t.innerHTML="",poi_list.entries=[],e){(n=document.createElement("li")).innerHTML="(back)",n.className="dungeon-entry",n.onclick=function(){fillDungeonList(),document.getElementById("dungeon-name").removeAttribute("data-mode")},n.style.cursor="pointer",t.appendChild(n);for(let a in e){i=e[a];(s=document.createElement("li")).id=a,s.innerHTML=translate(a),addBadge(s,i.age,i.time),s.setAttribute("data-category",poi_list.mode),s.onclick=togglePOI,s.oncontextmenu=untogglePOI,s.style.cursor="pointer",i.mode&&s.setAttribute("data-mode",i.mode),poi_list.entries.push(s),t.appendChild(s)}}else{var a=document.getElementById("dungeon-name");poi_list.ref="",a.ref=null,a.innerHTML="Hyrule";var n=document.createElement("li");n.innerHTML="Overworld",n.setAttribute("data-ref","overworld"),n.onclick=loadDungeonList,n.style.cursor="pointer",n.className="dungeon-entry DCAvailable",poi_list.entries.push(n),t.appendChild(n),e=data.dungeons;for(let a in e){var i=e[a],s=document.createElement("li");s.innerHTML=translate(a),addBadge(s,i.age,i.time),s.setAttribute("data-ref",a),s.onclick=loadDungeonList,s.style.cursor="pointer",s.className="dungeon-entry DCAvailable",poi_list.entries.push(s),t.appendChild(s)}}updateMap()}function reloadDungeonList(){poi_list.ref&&poi_list.ref.length?loadDungeonList(poi_list.ref):updateMap()}function updateMap(){for(var e=0,t=0,a=0,n=0,i=0;i<poi.chests.length;++i){m=poi.chests[i];if(SaveState.read("chests",m.id,0))m.className="poi chest opened";else{c=checkLogic("chests",m.id);m.className="poi chest "+(c?"available":"unavailable"),data.chests[m.id].mode&&"scrubsanity"==data.chests[m.id].mode&&!SaveState.read("options","scrubsanity",!1)||(t++,c&&e++)}}for(i=0;i<poi.dungeons.length;++i){g=(m=poi.dungeons[i]).id.slice(8);m.className="poi dungeon "+checkList(poi_list.mode,g);var s=data.dungeons[g].chests,o=data.dungeons[g].skulltulas;data.dungeons[g].hasmq&&SaveState.read("mq",g,!1)&&(s=data.dungeons[g].chests_mq,o=data.dungeons[g].skulltulas_mq);var r=0;for(let e in s)SaveState.read("chests",e,0)||s[e].mode&&"scrubsanity"==s[e].mode&&!SaveState.read("options","scrubsanity",!1)||(t++,checkLogic("chests",e)&&r++);e+=r;var l=0;for(let e in o)SaveState.read("skulltulas",e,0)||(checkLogic("skulltulas",e)&&l++,n++);if(a+=l,"chests"==poi_list.mode){(d=m.children[0]).innerHTML=0==r?"":r}else if("skulltulas"==poi_list.mode){var d=m.children[0];d.innerHTML=0==l?"":l}}for(i=0;i<poi.skulltulas.length;++i){m=poi.skulltulas[i];if(SaveState.read("skulltulas",m.id,0))m.className="poi skulltula opened";else{var c;(c=checkLogic("skulltulas",m.id))&&a++,m.className="poi skulltula "+(c?"available":"unavailable"),n++}}var u=document.getElementById("dungeon-name");"chests"==poi_list.mode&&""!=poi_list.ref?u.className="DC"+checkBeatList(poi_list.ref):u.className="DCavailable";for(i=0;i<poi_list.entries.length;++i){var m=poi_list.entries[i];if(SaveState.read(poi_list.mode,m.id,0))m.className="dungeon-entry DCopened";else{var g;(g=m.getAttribute("data-ref"))?m.className="dungeon-entry DC"+checkList(poi_list.mode,g):(g=m.id,checkLogic(poi_list.mode,g)?m.className="dungeon-entry DCavailable":m.className="dungeon-entry DCunavailable")}}setStatus("chests-available",e),setStatus("chests-missing",t),setStatus("skulltulas-available",a),setStatus("skulltulas-missing",n)}function toggleStateButtons(){""==stateChoice.value?(stateSave.disabled=!0,stateLoad.disabled=!0,stateDel.disabled=!0,stateExport.disabled=!0,stateRename.disabled=!0):(stateChoice.value==activestate?stateSave.disabled=!1:stateSave.disabled=!0,stateLoad.disabled=!1,stateDel.disabled=!1,stateExport.disabled=!1,stateRename.disabled=!1)}function prepairSavegameChoice(){stateChoice.innerHTML='<option disabled selected hidden value=""> -- select state -- </option>';for(var e=Storage.names("save"),t=0;t<e.length;++t){var a=document.createElement("option");a.id=e[t],a.innerHTML=a.id,stateChoice.appendChild(a)}stateChoice.value=activestate}async function state_Save(){""!=stateChoice.value&&(stateChoice.value=activestate,SaveState.save(activestate),await Dialog.alert("Success",'Saved "'+activestate+'" successfully.'))}async function state_Load(){if(""!=stateChoice.value){var e=!0;""!=activestate&&(e=await Dialog.confirm("Warning","Do you really want to load? Unsaved changes will be lost.")),e&&(activestate=stateChoice.value,SaveState.load(activestate),resetSettingsPage("options",document.getElementById("settings-options")),resetSettingsPage("skips",document.getElementById("settings-skips")),updateItems(),rebuildAllShops(),applySettingsChoices(),toggleStateButtons(),await Dialog.alert("Success",'State "'+activestate+'" loaded.'))}}async function state_Delete(){if(""!=stateChoice.value&&await Dialog.confirm("Warning",'Do you really want to delete "'+stateChoice.value+'"?')){var e=stateChoice.value;Storage.remove("save",e),e!=activestate&&(updateItems(),updateMap()),stateChoice.value=activestate,prepairSavegameChoice(),toggleStateButtons(),await Dialog.alert("Success",'State "'+e+'" removed.')}}async function state_New(){var e=await Dialog.prompt("New state","Please enter a new name! (Unsaved changes will be lost.)");if(!1!==e){if(""==e)return await Dialog.alert("Warning","The name can not be empty."),void state_New();if(Storage.has("save",e))return await Dialog.alert("Warning","The name already exists."),void state_New();""!=activestate?await Dialog.confirm("Success",'State "'+e+'" created.<br>Do you want to reset the current state?')&&SaveState.reset():(await Dialog.alert("Success",'State "'+e+'" created.'),SaveState.reset()),SaveState.save(e),stateChoice.value=e,activestate=e,resetSettingsPage("options",document.getElementById("settings-options")),resetSettingsPage("skips",document.getElementById("settings-skips")),prepairSavegameChoice(),updateItems(),rebuildAllShops(),applySettingsChoices(),toggleStateButtons()}}async function state_Rename(){if(""!=stateChoice.value&&await Dialog.confirm("Warning",'Do you really want to rename "'+stateChoice.value+'"?')){var e=await Dialog.prompt("New state","Please enter a new name!");if(!1!==e){if(""==e)return await Dialog.alert("Warning","The name can not be empty."),void state_New();if(Storage.has("save",e))return await Dialog.alert("Warning","The name already exists."),void state_New();var t=Storage.get("save",stateChoice.value);Storage.remove("save",stateChoice.value),Storage.set("save",e,t),prepairSavegameChoice(),""!=activestate&&activestate==stateChoice.value&&(activestate=e),stateChoice.value=e,toggleStateButtons()}}}async function state_Export(){if(""!=stateChoice.value){var e=!0;if(""!=activestate&&(e=await Dialog.confirm("Are you shure?","The last saved state will be exported.")),e){var t={name:stateChoice.value,data:Storage.get("save",stateChoice.value)};await Dialog.alert("Your export string",btoa(JSON.stringify(t)).replace(/=*$/,""))}}}async function state_Import(){var e=await Dialog.prompt("Import","Please enter export string!");if(!1!==e){if(""==e)return await Dialog.alert("Warning","The import string can not be empty."),void state_Import();if(e=JSON.parse(atob(e)),Storage.has("save",e.name)&&!await Dialog.confirm("Warning","There is already a savegame with this name. Replace savegame?."))return;Storage.set("save",e.name,e.data),prepairSavegameChoice(),await Dialog.confirm('Imported "'+e.name+'" successfully.',"Do you want to load the imported state?"+(""==activestate?"":" Unsaved changes will be lost."))&&(stateChoice.value=e.name,activestate=e.name,SaveState.load(activestate),updateItems(),applySettingsChoices(),toggleStateButtons())}}function generateSettingsPage(e,t){for(let r in data.rom_options[e]){var a=document.createElement("label"),n=data.rom_options[e][r];a.className="settings-option";var i=document.createElement("span");i.innerHTML=translate(r),i.className="option-text",a.appendChild(i);var s;switch(n.type){case"check":(s=document.createElement("input")).className="settings-input",s.setAttribute("type","checkbox"),s.checked=SaveState.read(e,r,n.default);break;case"choice":(s=document.createElement("select")).className="settings-input";for(let e in n.values){var o=document.createElement("option");o.innerHTML=translate(n.values[e]),o.setAttribute("value",n.values[e]),s.appendChild(o)}s.value=SaveState.read(e,r,n.default)}s.setAttribute("data-ref",r),a.appendChild(s),t.appendChild(a)}}function resetSettingsPage(e,t){var a=Array.from(t.querySelectorAll(".settings-option"));for(let t in a){var n=a[t].querySelector(".settings-input"),i=n.getAttribute("data-ref"),s=data.rom_options[e][i];switch(n.nodeName){case"INPUT":n.checked=SaveState.read(e,i,s.default);break;case"SELECT":n.value=SaveState.read(e,i,s.default)}}}function readSettingsPage(e,t){var a=Array.from(t.querySelectorAll(".settings-option"));for(let t in a){var n=a[t].querySelector(".settings-input"),i=n.getAttribute("data-ref");switch(n.nodeName){case"INPUT":SaveState.write(e,i,n.checked);break;case"SELECT":SaveState.write(e,i,n.value)}}}function buildSettings(){var e=document.getElementById("edit-settings"),t=document.getElementById("settings-cancel"),a=document.getElementById("settings-save"),n=document.getElementById("settings"),i=document.getElementById("settings-options"),s=document.getElementById("settings-skips"),o=n.querySelector("#layout"),r=n.querySelector("#item-scale-slider"),l=n.querySelector("#show_hint_badges"),d=n.querySelector("#use_custom_logic");r.addEventListener("input",function(e){n.querySelector("#item-scale-slider+.input-value").innerHTML=e.currentTarget.value+"px"}),e.addEventListener("click",function(){n.classList.add("active")}),t.addEventListener("click",function(){o.value=Storage.get("settings","layout","map-compact"),r.value=Storage.get("settings","itemsize",40),l.checked=Storage.get("settings","show_hint_badges",!1),d.checked=Storage.get("settings","use_custom_logic",!1),resetSettingsPage("options",i),resetSettingsPage("skips",s),n.classList.remove("active")}),a.addEventListener("click",function(){Storage.set("settings","use_custom_logic",d.checked),Storage.set("settings","show_hint_badges",l.checked),Storage.set("settings","layout",o.value),Storage.set("settings","itemsize",r.value),readSettingsPage("options",i),readSettingsPage("skips",s),applySettingsChoices(),reloadDungeonList(),updateMap(),data.logic_patched=Storage.get("settings","logic",{}),document.getElementById("settings").classList.remove("active")});Array.from(n.querySelectorAll(".card-button")).forEach(function(e){e.addEventListener("click",function(e){if(!e.target.classList.contains("disabled")){Array.from(n.querySelectorAll(".card-body, .card-button")).forEach(function(e){e.classList.remove("active")});n.querySelector("#"+e.target.getAttribute("data-target")).classList.add("active"),e.target.classList.add("active")}})}),generateSettingsPage("options",i),generateSettingsPage("skips",s),o.value=Storage.get("settings","layout","map-compact"),r.value=Storage.get("settings","itemsize",40),l.checked=Storage.get("settings","show_hint_badges",!1),d.checked=Storage.get("settings","use_custom_logic",!1),applySettingsChoices()}function applySettingsChoices(){var e=document.querySelector(".layout-container[data-layout]");e.setAttribute("data-layout",Storage.get("settings","layout","map-compact")),e.style.setProperty("--item-size",Storage.get("settings","itemsize",40)+"px"),Storage.get("settings","show_hint_badges",!1)?document.body.setAttribute("data-hint-badges","true"):document.body.setAttribute("data-hint-badges","false"),SaveState.read("options","scrubsanity",!1)?document.body.setAttribute("data-scrubsanity","true"):document.body.setAttribute("data-scrubsanity","false")}function changeItemInactiveEffect(){var e=parseInt(document.getElementById("item-container").getAttribute("data-inactive"))||0;++e>2&&(e=0),document.getElementById("item-container").setAttribute("data-inactive",e)}async function main(){if("serviceWorker"in navigator)try{await navigator.serviceWorker.register("/script/ServiceWorker.js"),console.log("Service Worker Registered")}catch(e){console.error(e)}FileLoader.onupdate=Splash.update,data=await loadAll(),Splash.hide(),map_scale_slider.value=Storage.get("settings","map_zoom",90),document.getElementById("map").style.setProperty("--map-scale",parseInt(map_scale_slider.value)/100),buildSettings(),prepairSavegameChoice(),createItemTracker(),populateMap()}function translate(e){return data.lang[e]?data.lang[e]:e}function setStatus(e,t){document.getElementById("status-"+e).innerHTML=t}!function(){function e(){var e="dialog_"+ ++a,t={container:document.createElement("DIV"),window:document.createElement("DIV"),focusCT:document.createElement("DIV"),focusCB:document.createElement("DIV"),title:document.createElement("DIV"),text:document.createElement("DIV"),body:document.createElement("DIV"),footer:document.createElement("DIV"),submit:document.createElement("BUTTON"),abort:document.createElement("BUTTON"),close:document.createElement("button")};return t.close.className="dialog-close",t.close.setAttribute("title","close"),t.submit.className="hidden",t.submit.setAttribute("type","submit"),t.abort.className="hidden",t.abort.setAttribute("type","reset"),t.title.id=e+"_title",t.title.className="dialog-title hidden",t.text.id=e+"_text",t.text.className="dialog-text hidden",t.body.className="dialog-body",t.body.appendChild(t.text),t.footer.className="dialog-footer",t.footer.appendChild(t.submit),t.footer.appendChild(t.abort),t.focusCT.setAttribute("tabindex","0"),t.focusCB.setAttribute("tabindex","0"),t.window.className="dialog-window",t.window.id=e,t.window.setAttribute("role","dialog"),t.window.setAttribute("aria-modal","true"),t.window.appendChild(t.title),t.window.appendChild(t.body),t.window.appendChild(t.footer),t.window.appendChild(t.close),t.container.className="dialog",t.container.appendChild(t.focusCT),t.container.appendChild(t.window),t.container.appendChild(t.focusCB),t}const t=['button:not([tabindex="-1"])','[href]:not([tabindex="-1"])','input:not([tabindex="-1"])','select:not([tabindex="-1"])','textarea:not([tabindex="-1"])','[tabindex]:not([tabindex="-1"])'].join(",");var a=0;window.Dialog=function(a,n){function i(e){"function"==typeof a&&a(!!e),document.body.removeChild(s.container),n&&n.focus()}var s=e(),o=[];s.focusCT.onfocus=function(){o.length&&o[o.length-1].focus()},s.focusCB.onfocus=function(){o.length&&o[0].focus()},s.container.onkeydown=function(e){27==(e.which||e.keyCode)&&i(),e.stopPropagation()},s.submit.onclick=function(){i(!0)},s.abort.onclick=function(){i()},s.close.onclick=function(){i()},this.setTitle=function(e){return void 0===e?(s.title.classList.add("hidden"),target.removeAttribute("aria-labelledby")):(s.title.classList.remove("hidden"),s.title.innerHTML=e,s.window.setAttribute("aria-labelledby",s.title.id)),this},this.setText=function(e){return void 0===e?(s.text.classList.add("hidden"),target.removeAttribute("aria-describedby")):(s.text.classList.remove("hidden"),s.text.innerHTML=e,s.window.setAttribute("aria-describedby",s.text.id)),this},this.setSubmitText=function(e){return s.submit.classList.remove("hidden"),s.submit.innerHTML=e.toUpperCase(),s.submit.setAttribute("title",e),o=Array.from(s.window.querySelectorAll(t)),this},this.setAbortText=function(e){return s.abort.classList.remove("hidden"),s.abort.innerHTML=e.toUpperCase(),s.abort.setAttribute("title",e),o=Array.from(s.window.querySelectorAll(t)),this},this.setCloseText=function(e){return s.close.setAttribute("title",e),tab_btns.push(s.close),this},this.addElement=function(e){return s.body.appendChild(e),o=Array.from(s.window.querySelectorAll(t)),this},o=Array.from(s.window.querySelectorAll(t)),document.body.appendChild(s.container)},Dialog.alert=function(e,t,a){return new Promise(function(n){new Dialog(n,a).setTitle(e).setText(t).setSubmitText("OK")})},Dialog.confirm=function(e,t,a){return new Promise(function(n){new Dialog(n,a).setTitle(e).setText(t).setSubmitText("YES").setAbortText("NO")})},Dialog.prompt=function(e,t,a){return new Promise(function(n){var i=document.createElement("input");i.className="dialog-input",new Dialog(function(e){n(!!e&&i.value)},a).setTitle(e).setText(t).setSubmitText("SUBMIT").setAbortText("ABORT").addElement(i)})}}(),window.SaveState=new function(){var e={};this.save=function(t){Storage.set("save",t,e)},this.load=function(t){e=Storage.get("save",t)},this.write=function(t,a,n){e[t]=e[t]||{},e[t][a]=n},this.read=function(t,a,n){return e.hasOwnProperty(t)&&e[t].hasOwnProperty(a)?e[t][a]:n},this.reset=function(){e={}}},window.Storage=new function(){this.set=function(e,t,a){localStorage.setItem(e+"\0"+t,JSON.stringify(a))},this.get=function(e,t,a=null){try{var n=localStorage.getItem(e+"\0"+t);return n&&null!=n?JSON.parse(n):a}catch(e){return a}},this.has=function(e,t){return localStorage.hasOwnProperty(e+"\0"+t)},this.remove=function(e,t){localStorage.removeItem(e+"\0"+t)},this.categories=function(){var e=Object.keys(localStorage);return Array.from(new Set(e.map(function(e){return e.split("\0")[0]})))},this.names=function(e){var t=Object.keys(localStorage);return Array.from(new Set(t.filter(function(t){return t.startsWith(e+"\0")}).map(function(e){return e.split("\0")[1]})))}},window.FileLoader=new function(){var e=0,t=0;this.onupdate=null,this.addFont=function(a,n,i="normal",s=400){e++,"function"==typeof this.onupdate&&this.onupdate(e,t);var o=new FontFace(a,"url("+n+")",{style:i,weight:s});return document.fonts.add(o),o.loaded.then(function(a){return t++,"function"==typeof this.onupdate&&this.onupdate(e,t),a}.bind(this))},this.loadText=function(a){return e++,"function"==typeof this.onupdate&&this.onupdate(e,t),fetch(new Request(a,{method:"GET",headers:new Headers({"Content-Type":"text/plain",Pragma:"no-cache","Cache-Control":"no-cache"}),mode:"cors",cache:"default"})).then(function(a){return t++,"function"==typeof this.onupdate&&this.onupdate(e,t),a.text()}.bind(this))},this.loadAllText=function(e){var t=[];for(let a in e)t.push(this.loadText(e[a]));return Promise.all(t)},this.loadJSON=function(a){return e++,"function"==typeof this.onupdate&&this.onupdate(e,t),fetch(new Request(a,{method:"GET",headers:new Headers({"Content-Type":"application/json",Pragma:"no-cache","Cache-Control":"no-cache"}),mode:"cors",cache:"default"})).then(function(a){return t++,"function"==typeof this.onupdate&&this.onupdate(e,t),a.json()}.bind(this))},this.loadAllJSON=function(e){var t=[];for(let a in e)t.push(this.loadJSON(e[a]));return Promise.all(t)}},Splash=new function(){var e=document.getElementById("splash"),t=e.querySelector(".loading");this.update=function(e,a){t.innerHTML="Loading... "+a+"/"+e},this.hide=function(){e.className="inactive"}};var itemGridEls=[],poi={chests:[],dungeons:[],skulltulas:[]},poi_list={mode:"chests",ref:"",entries:[]},map=new Map(document.getElementById("map-scroll"),"../images/map.png",825,466);document.getElementById("dungeon-name").addEventListener("click",function(e){toogleDungeonMQ(e.currentTarget.ref)}),document.getElementById("dungeon-switch").addEventListener("click",function(e){poi_list.mode="chests"==poi_list.mode?"skulltulas":"chests",e.currentTarget.setAttribute("data-mode",poi_list.mode),reloadDungeonList()});var activestate="",stateChoice=document.getElementById("select-savegame"),stateSave=document.getElementById("save-savegame"),stateLoad=document.getElementById("load-savegame"),stateNew=document.getElementById("new-savegame"),stateDel=document.getElementById("delete-savegame"),stateRename=document.getElementById("rename-savegame"),stateExport=document.getElementById("export-savegame"),stateImport=document.getElementById("import-savegame");stateSave.addEventListener("click",state_Save),stateLoad.addEventListener("click",state_Load),stateNew.addEventListener("click",state_New),stateDel.addEventListener("click",state_Delete),stateRename.addEventListener("click",state_Rename),stateExport.addEventListener("click",state_Export),stateImport.addEventListener("click",state_Import),stateChoice.addEventListener("change",toggleStateButtons);var data={},map_scale_slider=document.getElementById("map-scale-slider");map_scale_slider.addEventListener("input",function(e){document.getElementById("map").style.setProperty("--map-scale",parseInt(map_scale_slider.value)/100)}),map_scale_slider.addEventListener("change",function(e){document.getElementById("map").style.setProperty("--map-scale",parseInt(map_scale_slider.value)/100),Storage.set("settings","map_zoom",parseInt(map_scale_slider.value))}),document.getElementById("map-option-shops").addEventListener("click",function(e){document.getElementById("shop-view").classList.add("active")}),document.getElementById("shop-view-close-button").addEventListener("click",function(e){document.getElementById("shop-view").classList.remove("active")}),window.onfocus=function(e){data.logic_patched=Storage.get("settings","logic",{}),updateMap()},window.oncontextmenu=function(e){return e.preventDefault(),!1},main(),document.getElementById("erase_all_data").onclick=function(){Dialog.prompt("Erase all data?",'You are about to erase all data.<br>Please enter "ERAZE" to continue.<br><br>Warning: This cant be undone!').then(function(e){"ERAZE"===e&&(window.location="deleted.html")})};